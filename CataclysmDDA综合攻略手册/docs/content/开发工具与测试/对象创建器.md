# 对象创建器

<cite>
**本文引用的文件**
- object_creator/creator_main.cpp
- object_creator/creator_main_window.h
- object_creator/creator_main_window.cpp
- object_creator/spell_window.h
- object_creator/item_group_window.h
- object_creator/mod_selection_window.h
- src/json.h
- src/json.cpp
- src/flexbuffer_json.cpp
- src/item_factory.h
- src/item_factory.cpp
- src/item_group.h
- src/item_group.cpp
- src/magic.h
- build-scripts/validate_json.py
- tools/format/format.cpp
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本文件为 Cataclysm: DDA 对象创建器（Object Creator）的详细使用与技术文档。对象创建器是一个基于 Qt 的图形化工具，用于辅助模组开发者与内容创作者高效地创建与编辑游戏中的各类对象定义，包括法术（Spell）、物品组（Item Group）以及模组选择（Mod Selection）。该工具通过直观的界面与实时 JSON 输出，帮助用户在不直接手写复杂 JSON 结构的情况下完成高质量的内容创作。

对象创建器的核心目标：
- 提供可视化的表单界面，降低 JSON 编写的门槛
- 实时生成可直接导入游戏的数据结构
- 支持多标签页工作流：法术、物品组、模组选择
- 集成模组加载与校验流程，确保生成内容与当前世界配置兼容

## 项目结构
对象创建器位于独立的 object_creator 目录中，采用模块化设计，主窗口负责组织标签页，各标签页对应不同的对象类型编辑器。同时，工具通过构建脚本与 JSON 校验工具进行集成，确保生成内容符合游戏引擎的解析要求。

```mermaid
graph TB
subgraph "对象创建器"
A["creator_main.cpp<br/>入口与初始化"]
B["creator_main_window.h/.cpp<br/>主窗口与菜单栏/标签页"]
C["spell_window.h<br/>法术编辑器"]
D["item_group_window.h<br/>物品组编辑器"]
E["mod_selection_window.h<br/>模组选择器"]
end
subgraph "游戏引擎与JSON系统"
F["src/json.h/.cpp<br/>JSON解析与错误报告"]
G["src/flexbuffer_json.cpp<br/>Flexbuffer路径定位与错误"]
H["src/item_factory.h/.cpp<br/>物品组加载入口"]
I["src/item_group.h/.cpp<br/>物品组模型与上下文"]
J["src/magic.h<br/>法术类型与标志"]
K["build-scripts/validate_json.py<br/>JSON校验脚本"]
L["tools/format/format.cpp<br/>JSON格式化工具"]
end
A --> B
B --> C
B --> D
B --> E
C --> J
D --> H
H --> I
F --> H
F --> I
G --> F
K --> F
L --> F
```

图表来源
- object_creator/creator_main.cpp
- object_creator/creator_main_window.cpp
- object_creator/spell_window.h
- object_creator/item_group_window.h
- object_creator/mod_selection_window.h
- src/json.h
- src/flexbuffer_json.cpp
- src/item_factory.h
- src/item_group.h
- src/magic.h

章节来源
- object_creator/creator_main.cpp
- object_creator/creator_main_window.cpp

## 核心组件
- 主窗口与应用生命周期
  - 负责创建主窗口、菜单栏、标签页容器，以及启动时的闪屏与设置加载。
  - 初始化游戏静态数据与世界配置，确保后续编辑器可用的上下文。
- 法术编辑器（Spell Window）
  - 提供法术 ID、名称、描述、能量消耗、伤害范围、施法时间、持续时间、法术标志、法术类别、技能需求、音效与消息等字段的可视化输入。
  - 内置“法术列表”与“额外法术”等交互控件，支持复杂法术组合。
- 物品组编辑器（Item Group Window）
  - 提供嵌套集合/分布结构的可视化编辑，支持条目权重、概率、弹药、容器、损坏度、数量、计数等属性的灵活配置。
  - 支持搜索与拖拽操作，便于从大量物品与分组中快速选择。
- 模组选择器（Mod Selection Window）
  - 提供双列表控件，允许用户在可用模组间移动选择，保存到 QSettings 中，作为世界生成时的模组激活依据。

章节来源
- object_creator/creator_main_window.h
- object_creator/creator_main_window.cpp
- object_creator/spell_window.h
- object_creator/item_group_window.h
- object_creator/mod_selection_window.h

## 架构总览
对象创建器采用“主窗口组织 + 多编辑器标签页”的结构，每个编辑器负责特定对象类型的可视化与 JSON 输出。编辑器通过游戏引擎提供的 JSON 解析与加载接口，将用户输入转换为标准的 JSON 数据结构，随后由构建脚本或游戏加载流程进行进一步处理。

```mermaid
sequenceDiagram
participant App as "应用程序(QApplication)"
participant MW as "主窗口(main_window)"
participant SW as "法术编辑器(spell_window)"
participant IGW as "物品组编辑器(item_group_window)"
participant MSW as "模组选择器(mod_selection_window)"
participant IF as "物品工厂(item_factory)"
participant IG as "物品组(item_group)"
participant JS as "JSON系统(json.h/.cpp)"
App->>MW : 初始化并显示主窗口
MW->>SW : 创建并添加“法术”标签页
MW->>IGW : 创建并添加“物品组”标签页
MW->>MSW : 创建并添加“模组选择”标签页
SW->>JS : 将表单字段序列化为JSON文本
IGW->>IF : 触发物品组数据加载
IF->>IG : 解析并填充物品组结构
IG->>JS : 生成标准JSON输出
JS-->>App : 错误/警告信息含未访问成员提示
```

图表来源
- object_creator/creator_main_window.cpp
- object_creator/spell_window.h
- object_creator/item_group_window.h
- src/item_factory.h
- src/item_group.h
- src/json.h

## 详细组件分析

### 法术编辑器（Spell Window）
法术编辑器提供完整的法术定义界面，覆盖法术的基础属性、数值范围、效果类型、目标与音效等。其核心职责是将用户输入映射到标准的法术 JSON 结构，并在需要时生成可读的 JSON 文本以供导出或调试。

```mermaid
classDiagram
class SpellWindow {
+show()
+hide()
-write_json()
-populate_fields()
-editable_spell : spell_type
-spell_json : QTextEdit
-id_box : QLineEdit
-name_box : QLineEdit
-description_box : QPlainTextEdit
-valid_targets_box : QListWidget
-energy_cost_box : QSpinBox
-damage_boxes : QSpinBox/QDoubleSpinBox
-range_boxes : QSpinBox/QDoubleSpinBox
-aoe_boxes : QSpinBox/QDoubleSpinBox
-dot_boxes : QSpinBox/QDoubleSpinBox
-pierce_boxes : QSpinBox/QDoubleSpinBox
-casting_time_boxes : QSpinBox/QDoubleSpinBox
-duration_boxes : QSpinBox/QDoubleSpinBox
-spell_flags_box : QListWidget
-spell_items_box : QListWidget
-energy_source_box : QComboBox
-dmg_type_box : QComboBox
-spell_class_box : QComboBox
-difficulty_box : QSpinBox
-max_level_box : QSpinBox
-spell_message_box : QLineEdit
-components_box : QComboBox
-skill_box : QComboBox
-field_id_box : QComboBox
-field_chance_box : QSpinBox
-field_intensity_boxes : QSpinBox/QDoubleSpinBox
-affected_bps_box : QListWidget
-effect_box : QComboBox
-effect_str_box : QLineEdit
-shape_box : QComboBox
-sound_* boxes : QLineEdit/QComboBox/QCheckBox
-additional_spells_box : fake_spell_listbox
-targeted_monster_ids_box : dual_list_box
-learn_spells_box : QTableWidget
}
```

图表来源
- object_creator/spell_window.h

章节来源
- object_creator/spell_window.h

### 物品组编辑器（Item Group Window）
物品组编辑器支持复杂的嵌套结构（集合/分布），并通过拖拽与搜索实现高效的条目管理。其内部包含多个嵌套容器类，分别负责集合、分布与条目的 JSON 序列化逻辑。

```mermaid
classDiagram
class ItemGroupWindow {
+show()
+hide()
-write_json()
-items_search_return_pressed()
-group_search_return_pressed()
-group_list_populate_filtered(query)
-item_list_populate_filtered(query)
-set_item_tooltip(item, itype*)
-set_group_tooltip(item, item_group_id)
-item_group_json : QTextEdit
-id_box : QLineEdit
-comment_box : QLineEdit
-group_container : nested_group_container
-ammo_frame : simple_property_widget
-magazine_frame : simple_property_widget
-subtype : QComboBox
-containerItem : QLineEdit
-overflow : QComboBox
-item_search_box : QLineEdit
-item_list_total_box : ListWidget_Drag
-group_search_box : QLineEdit
-group_list_total_box : ListWidget_Drag
-scrollArea : QScrollArea
}
class NestedGroupContainer {
+get_json(JsonOut&)
-add_distribution()
-add_collection()
-change_notify_top_parent()
-items_container : QFrame
-verticalBox : QVBoxLayout
}
class DistributionCollection {
+get_json(JsonOut&)
+set_bg_color()
+set_depth(int)
-entryType : QComboBox
-verticalBox : QVBoxLayout
-prob : QSpinBox
-add_entry(text, group)
-delete_self()
-change_notify_top_parent()
}
class ItemGroupEntry {
+get_json(JsonOut&)
-variant_frame : simple_property_widget
-contentsItem_frame : simple_property_widget
-contentsGroup_frame : simple_property_widget
-containerItem_frame : simple_property_widget
-ammoItem_frame : simple_property_widget
-entryWrapper_frame : simple_property_widget
-sealed_frame : simple_property_widget
-damage_frame : simple_property_widget
-charges_frame : simple_property_widget
-count_frame : simple_property_widget
-prob_frame : simple_property_widget
-flowLayout : FlowLayout
-add_property : QComboBox
}
ItemGroupWindow --> NestedGroupContainer : "包含"
NestedGroupContainer --> DistributionCollection : "包含"
DistributionCollection --> ItemGroupEntry : "包含"
```

图表来源
- object_creator/item_group_window.h

章节来源
- object_creator/item_group_window.h

### 模组选择器（Mod Selection Window）
模组选择器提供双列表控件，允许用户在“可用模组”与“已选模组”之间移动，最终将结果保存至 QSettings，供世界生成时使用。

```mermaid
flowchart TD
Start(["打开模组选择器"]) --> LoadMods["加载可用模组列表"]
LoadMods --> MoveItems["用户在左右列表间移动项"]
MoveItems --> SaveSettings["保存到QSettings"]
SaveSettings --> WorldGen["世界生成时读取并激活模组"]
WorldGen --> End(["完成"])
```

图表来源
- object_creator/mod_selection_window.h

章节来源
- object_creator/mod_selection_window.h

### JSON 数据结构与验证规范
对象创建器生成的 JSON 必须遵循游戏引擎的解析规范。以下为关键要点：
- 字段命名与类型
  - 所有字段需与游戏定义一致；未被访问的成员会被标记为潜在错误，有助于发现拼写错误或遗漏字段。
  - 数值类型支持整型与浮点型，超出范围会触发错误。
- 嵌套结构
  - 物品组支持集合与分布两种模式，可通过数组或对象形式定义条目；条目可为字符串（引用已有分组/物品）、数组（物品ID与概率）或内联对象（包含多种属性）。
- 错误定位
  - JSON 解析器支持基于 Flexbuffer 的路径定位，结合源文件路径与偏移量，提供精确的错误位置信息。
- 格式化与校验
  - 工具链提供 JSON 格式化与校验脚本，建议在提交前运行以保证一致性与可读性。

```mermaid
flowchart TD
ParseStart(["开始解析JSON"]) --> TypeCheck["类型检查与范围校验"]
TypeCheck --> MemberVisit["记录已访问成员"]
MemberVisit --> HasUnvisited{"存在未访问成员？"}
HasUnvisited --> |是| ReportWarn["记录未访问成员警告"]
HasUnvisited --> |否| Continue["继续解析"]
Continue --> NestedStruct["进入嵌套结构如物品组"]
NestedStruct --> EntriesParse["解析entries/items/groups"]
EntriesParse --> EmitJSON["生成标准JSON输出"]
EmitJSON --> Done(["结束"])
```

图表来源
- src/json.h
- src/json.cpp
- src/flexbuffer_json.cpp
- src/item_factory.cpp
- src/item_group.cpp

章节来源
- src/json.h
- src/json.cpp
- src/flexbuffer_json.cpp
- src/item_factory.cpp
- src/item_group.cpp

## 依赖关系分析
对象创建器与游戏引擎之间的耦合主要体现在 JSON 解析与加载接口上。编辑器通过这些接口将用户输入转换为标准结构，再由引擎完成后续处理。

```mermaid
graph LR
OW["对象创建器<br/>spell_window.h / item_group_window.h"] --> IF["item_factory.h/.cpp<br/>加载入口与数据填充"]
IF --> IG["item_group.h/.cpp<br/>物品组模型与上下文"]
OW --> JS["json.h/.cpp<br/>解析与错误报告"]
JS --> FB["flexbuffer_json.cpp<br/>路径定位与错误"]
OW --> MS["mod_selection_window.h<br/>模组选择"]
MS --> WS["worldfactory.h<br/>世界生成"]
```

图表来源
- object_creator/spell_window.h
- object_creator/item_group_window.h
- object_creator/mod_selection_window.h
- src/item_factory.h
- src/item_group.h
- src/json.h
- src/flexbuffer_json.cpp

章节来源
- object_creator/spell_window.h
- object_creator/item_group_window.h
- object_creator/mod_selection_window.h
- src/item_factory.h
- src/item_group.h
- src/json.h
- src/flexbuffer_json.cpp

## 性能考虑
- 启动与闪屏
  - 应用启动时显示闪屏并短暂延迟，确保 UI 初始化完成后再进入事件循环，避免闪烁与卡顿。
- 模组加载
  - 在启动阶段加载静态数据与世界配置，减少编辑过程中的阻塞。
- JSON 解析
  - 使用流式解析与路径定位，避免一次性加载大文件导致内存峰值过高。
- UI 更新
  - 编辑器内部通过事件通知与增量更新，减少不必要的重绘与计算。

章节来源
- object_creator/creator_main.cpp
- object_creator/creator_main_window.cpp

## 故障排除指南
- 生成的 JSON 报错“存在未访问成员”
  - 检查是否遗漏了必需字段或拼写错误；根据日志提示定位具体键名。
- 数值越界或类型不匹配
  - 确认整型/浮点型范围与类型，避免超出支持范围或混用类型。
- 物品组无法解析
  - 检查 entries/items/groups 的结构与类型，确保条目为字符串、数组或对象之一。
- 模组未生效
  - 确认模组选择器中的模组已保存到设置，并在世界生成时正确读取。
- JSON 格式不规范
  - 使用工具链中的格式化与校验脚本进行预处理，提升可读性与一致性。

章节来源
- src/json.cpp
- src/json.h
- src/flexbuffer_json.cpp
- build-scripts/validate_json.py
- tools/format/format.cpp

## 结论
对象创建器通过直观的图形界面与严谨的 JSON 解析体系，显著降低了模组开发者在法术与物品组方面的创作门槛。配合模组选择与构建脚本，能够高效产出与游戏引擎兼容的内容。建议在开发过程中遵循字段命名规范、使用工具链进行格式化与校验，并关注 JSON 解析器的错误提示，以获得最佳的开发体验与内容质量。

## 附录
- 最佳实践
  - 先在法术编辑器中完成基础属性，再逐步细化数值与效果；最后导出 JSON 进行校验。
  - 物品组优先使用集合/分布的组合表达复杂掉落，避免过深嵌套。
  - 使用模组选择器明确启用所需模组，避免默认模组与自定义内容冲突。
- 常见问题
  - 若出现“无效字段名”或“值格式异常”，请对照游戏定义逐项核对键名与类型。
  - 若物品组解析失败，请确认条目类型与概率设置是否符合预期。